{% extends 'admin/model/list.html' %}

{% block model_list_table %}
<div class="table-responsive">
  <table class="table table-striped table-bordered table-hover model-list">
    <thead>
      <tr>
        <th>&nbsp;</th>
        {% for c, name in list_columns %}
        {% set column = loop.index0 %}
        <th class="column-header col-{{ c }}">
          {% if admin_view.is_sortable(c) %}
            {% if sort_column == column %}
              <a href="{{ sort_url(column, True) }}" title="Sort by {{ name }}">
                {{ name }}
                {% if sort_desc %}
                  <span class="fa fa-chevron-up"></span>
                {% else %}
                  <span class="fa fa-chevron-down"></span>
                {% endif %}
              </a>
            {% else %}
              <a href="{{ sort_url(column) }}" title="Sort by {{ name }}">{{ name }}</a>
            {% endif %}
          {% else %}
            {{ name }}
          {% endif %}
        </th>
        {% endfor %}
        <th>Update State</th>
      </tr>
    </thead>
    <tbody>
      {% for row in data %}
      <tr>
        <td class="list-buttons-column">
          <form method="POST" action="{{ url_for('.refund') }}" class="d-inline">
            <input type="hidden" name="payment_id" value="{{ row.session_id }}">
            <button type="submit" class="btn btn-sm btn-warning"
              onclick="return confirm('Mark {{ row.session_id }} as refunded?')">
              Refund
            </button>
          </form>
          <form method="POST" action="{{ url_for('.cancel') }}" class="d-inline ml-1">
            <input type="hidden" name="payment_id" value="{{ row.session_id }}">
            <button type="submit" class="btn btn-sm btn-danger"
              onclick="return confirm('Cancel payment {{ row.session_id }}?')">
              Cancel
            </button>
          </form>
          <form method="POST" action="{{ url_for('.sync') }}" class="d-inline ml-1">
            <input type="hidden" name="payment_id" value="{{ row.session_id }}">
            <button type="submit" class="btn btn-sm btn-info">Sync</button>
          </form>
        </td>
        {% for c, name in list_columns %}
        <td class="col-{{ c }}">
          {% if c == 'state' %}
            {% if row.state == 'succeeded' %}
              <span class="badge badge-success">{{ row.state }}</span>
            {% elif row.state == 'failed' %}
              <span class="badge badge-danger">{{ row.state }}</span>
            {% elif row.state == 'cancelled' %}
              <span class="badge badge-dark">{{ row.state }}</span>
            {% elif row.state == 'refunded' %}
              <span class="badge badge-warning">{{ row.state }}</span>
            {% elif row.state == 'processing' %}
              <span class="badge badge-info">{{ row.state }}</span>
            {% else %}
              <span class="badge badge-secondary">{{ row.state }}</span>
            {% endif %}
          {% elif c == 'session_id' %}
            <small>{{ row.session_id }}</small>
          {% else %}
            {{ row[c] }}
          {% endif %}
        </td>
        {% endfor %}
        <td>
          <form method="POST" action="{{ url_for('.update') }}" class="form-inline">
            <input type="hidden" name="payment_id" value="{{ row.session_id }}">
            <select name="state" class="form-control form-control-sm mr-1">
              {% for value, label in admin_view.state_choices %}
              <option value="{{ value }}" {% if value == row.state %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
            <button type="submit" class="btn btn-sm btn-primary">Update</button>
          </form>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="{{ list_columns|length + 2 }}">
          <div class="text-center">{{ admin_view.get_empty_list_message() }}</div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
