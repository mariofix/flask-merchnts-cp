{% extends 'admin/master.html' %}

{% block body %}
<div class="container-fluid">
  <h2>Payments</h2>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
  {% endwith %}

  <table class="table table-bordered table-striped">
    <thead>
      <tr>
        <th>Payment ID</th>
        <th>Provider</th>
        <th>Amount</th>
        <th>Currency</th>
        <th>State</th>
        <th>Update State</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for p in payments %}
      <tr>
        <td><small>{{ p.session_id }}</small></td>
        <td>{{ p.provider }}</td>
        <td>{{ p.amount }}</td>
        <td>{{ p.currency }}</td>
        <td>
          <span class="badge badge-secondary">{{ p.state }}</span>
        </td>
        <td>
          <form method="POST" action="{{ url_for('.update') }}" class="form-inline">
            <input type="hidden" name="payment_id" value="{{ p.session_id }}">
            <select name="state" class="form-control form-control-sm mr-1">
              {% for value, label in state_choices %}
              <option value="{{ value }}" {% if value == p.state %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
            <button type="submit" class="btn btn-sm btn-primary">Update</button>
          </form>
        </td>
        <td>
          <form method="POST" action="{{ url_for('.refund') }}" class="d-inline">
            <input type="hidden" name="payment_id" value="{{ p.session_id }}">
            <button type="submit" class="btn btn-sm btn-warning"
              onclick="return confirm('Mark {{ p.session_id }} as refunded?')">
              Refund
            </button>
          </form>
          <form method="POST" action="{{ url_for('.cancel') }}" class="d-inline ml-1">
            <input type="hidden" name="payment_id" value="{{ p.session_id }}">
            <button type="submit" class="btn btn-sm btn-danger"
              onclick="return confirm('Cancel payment {{ p.session_id }}?')">
              Cancel
            </button>
          </form>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="7" class="text-center text-muted">No payments recorded yet.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
